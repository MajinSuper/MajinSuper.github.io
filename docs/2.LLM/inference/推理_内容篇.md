---
title: LLM推理
tags:
  - LLM inference
---

## LLM 推理（内容篇）


### 大模型稳定输出json

好文连接：

- OpenAI结构化输出:https://jishuzhan.net/article/1950087025666863105
- 结构化输出:JSON Mode 与 Pydantic https://zhuanlan.zhihu.com/p/1978740200084619518
- DeepSeek官方文档：https://api-docs.deepseek.com/zh-cn/guides/json_mode
- OpenAI官方文档：https://platform.openai.com/docs/guides/structured-outputs

|                         | 原理                                                         | 实例                                                         |
| ----------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 提示工程（+In context） |                                                              | 输出符合Json标准的格式，字段名用引号。格式如下：{“name”:“value1”,…}<br>示例1：{"name": "张三", "age": 25} |
| 检查温度参数            | 温度高(>0.3)，在分布中会选非最优token<br>追求多样化、不固定，会导致格式偏差 | response= client.chat.completions.create(<br>    …<br>    temperature=0.1<br>   …<br>) |
| JSON Mode               | 受限解码（constrained decoding）,生成每个token时，进行语法检查（状态机） | response= client.chat.completions.create(<br/>    …<br/>    **response_format={ "type": "json_object" }**<br/>   …<br/>) |
| Structured Output       | 定义Pydantic类，自动将其转成schema                           | **from pydantic import BaseModel**<br>**class DateEvent(BaseModel):<br>&emsp;name: str<br>&emsp;date: str<br>&emsp;person_list: list[str]**<br>response = client.reponse.parse(<br>&emsp;…<br>&emsp;**text_format = DateEvent**<br>)<br>response.output_parsed<br>#*name='科学展' date='周五' person_list=['小王', '小李']* |
| 工程上，修复和重试      | 使用json_repair进行修复<br>解析失败进行重新生成，重试若干次  | json_repair.loads(response.final_output)<br>try-except rerun |

::: details 问题1: 结构化输出和json mode有什么区别？

- ==json mode==要求输出的符合json==语法==，对于是不是缺少字段，字段名称是否正确没有要求

- ==结构化输出==是要求输出符合schema的==语义==，必须严格按照字段名、字段类型返回

:::

:::deatails 问题2：流式输出和结构化数据怎么结合？

- 实践时，做了一些显示的约定。比如章节结构体，大纲的步骤、自检内容，只展示出步骤时，约定好在“plan_list”开始展示、在“self-check”后不再展示。
- 也可以使用，部分解析器（Partial Parser）

:::



### 模型输出重复

### overthinking